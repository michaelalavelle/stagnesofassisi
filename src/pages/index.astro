---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { fetchWordPressPostsByCategory } from "../lib/wordpress";

const formatDate = (value) =>
  new Intl.DateTimeFormat("en-US", { dateStyle: "long" }).format(value);

const announcementsLimit = 10;
const wordpressAnnouncements = await fetchWordPressPostsByCategory(
  "announcements",
  announcementsLimit
);

const rawLocalAnnouncements = (await getCollection("announcements"))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, announcementsLimit);

const localAnnouncements = await Promise.all(
  rawLocalAnnouncements.map(async (item) => {
    const { Content } = await item.render();
    return {
      source: "local",
      title: item.data.title,
      date: item.data.date,
      Content,
    };
  })
);

const announcements =
  wordpressAnnouncements.length > 0 ? wordpressAnnouncements : localAnnouncements;

const ensureTrailingSlash = (value) => (value.endsWith("/") ? value : `${value}/`);
const baseUrl = ensureTrailingSlash(import.meta.env.BASE_URL);
const heroSrc = `${baseUrl}stagneswithtext.png`;
const brochureUrl = `${baseUrl}st-agnes-fraternity-brochure.pdf`;
const contactUrl = `${baseUrl}contact/`;
---

<BaseLayout title="St. Agnes of Assisi Fraternity | Home">
  <section class="hero">
    <img
      class="hero-image"
      src={heroSrc}
      alt="St. Agnes of Assisi Fraternity"
    />
    <p>
      We are the Secular Franciscan Order in the Tau Cross Region, gathering at
      Our Lady of Lourdes Parish in West Islip, NY. All are welcome to learn
      about the Franciscan way of life in the world.
    </p>
    <div class="info-grid">
      <div class="card">
        <h2 class="section-title">Meeting Time</h2>
        <p>Second Sunday of every month at 2:00 PM</p>
      </div>
      <div class="card">
        <h2 class="section-title">Location</h2>
        <p>Our Lady of Lourdes Parish, West Islip, NY</p>
      </div>
      <div class="card">
        <h2 class="section-title">Who We Are</h2>
        <p>
          Lay women and men who follow in the footsteps of St. Francis of Assisi,
          living the Gospel through prayer, fraternity, and service.
        </p>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top: 2rem;">
    <h2 class="section-title">New to the OFS? Start here...</h2>
    <p>
      Formation in the OFS is a gradual process of learning, prayer, and
      discernment. We begin with inquiry, continue through candidacy and
      formation, and make a lifelong commitment through profession.
    </p>
    <p>
      If you are interested in learning more about our fraternity and the
      Secular Franciscan way of life, please read our brochure.
    </p>
    <p>
      <a href={brochureUrl} target="_blank" rel="noreferrer">
        St. Agnes of Assisi Fraternity Brochure (PDF)
      </a>
    </p>
    <p>
      Then <a href={contactUrl}>reach out to us using our contact form</a> to
      arrange a visit.
    </p>
  </section>

  <section class="card" style="margin-top: 2rem;">
    <h2 class="section-title">Announcements</h2>
    {announcements.length === 0 ? (
      <p>No announcements at this time. Please check back soon.</p>
    ) : (
      <div class="events-list">
        {announcements.map((item) => (
          <article class="event-item">
            <h3>
              {item.title} <span class="event-meta">(Posted {formatDate(item.date)})</span>
            </h3>
            {item.source === "wordpress" ? (
              <>
                <div set:html={item.html}></div>
              </>
            ) : (
              <item.Content />
            )}
          </article>
        ))}
      </div>
    )}
  </section>
</BaseLayout>
