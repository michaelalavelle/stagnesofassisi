---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { fetchWordPressPostsByCategory } from "../lib/wordpress";

const formatDate = (value) =>
  new Intl.DateTimeFormat("en-US", { dateStyle: "long" }).format(value);

const wordpressEvents = await fetchWordPressPostsByCategory("events", 50);

const rawLocalEvents = (await getCollection("events")).sort(
  (a, b) => a.data.date.getTime() - b.data.date.getTime()
);

const localEvents = await Promise.all(
  rawLocalEvents.map(async (item) => {
    const { Content } = await item.render();
    return {
      source: "local",
      title: item.data.title,
      date: item.data.date,
      location: item.data.location,
      Content,
    };
  })
);

const events = wordpressEvents.length > 0 ? wordpressEvents : localEvents;
---

<BaseLayout title="Events | St. Agnes of Assisi Fraternity">
  <section class="hero">
    <h1>Events</h1>
    <p>
      We gather on the second Sunday of each month at 2:00 PM. Additional
      gatherings, formation sessions, and regional events are listed below.
    </p>
  </section>

  <section class="card" style="margin-top: 2rem;">
    <h2 class="section-title">Upcoming Events</h2>
    <p class="event-meta">Documents open in a new tab.</p>
    {events.length === 0 ? (
      <p>No events have been posted yet. Please check back soon.</p>
    ) : (
      <div class="events-list">
        {events.map((item) => (
          <article class="event-item">
            <h3>
              {item.title} <span class="event-meta">(Posted {formatDate(item.date)})</span>
            </h3>
            {item.source === "local" && item.location ? (
              <p class="event-meta">{item.location}</p>
            ) : null}
            {item.source === "wordpress" ? <div set:html={item.html}></div> : <item.Content />}
          </article>
        ))}
      </div>
    )}
  </section>
</BaseLayout>
